<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deprem Ağı – Canlı Yayın Uyarı</title>
  <style>
    :root {
      --bg: rgba(0,0,0,0.65);
      --accent: #ff3b3b;
      --text: #fff;
    }
    html, body {
      margin: 0; padding: 0; background: transparent; overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
    }
    .banner {
      position: fixed; left: 50%; top: -200px; transform: translateX(-50%);
      min-width: 60vw; max-width: 90vw;
      color: var(--text); background: var(--bg);
      border: 2px solid var(--accent);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      border-radius: 10px; backdrop-filter: blur(6px);
      padding: 16px 20px; display: flex; gap: 12px; align-items: center;
      transition: transform 400ms ease, top 400ms ease, opacity 400ms ease;
      opacity: 0;
    }
    .banner.show {
      top: 24px; opacity: 1;
    }
    .pulse {
      width: 18px; height: 18px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 0 rgba(255,59,59,0.8);
      animation: pulse 1.5s infinite;
      flex: 0 0 auto;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,59,59,0.8); }
      70% { box-shadow: 0 0 0 16px rgba(255,59,59,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,59,59,0); }
    }
    .content { display: grid; gap: 4px; }
    .title { font-size: 22px; font-weight: 800; letter-spacing: 0.2px; }
    .meta { font-size: 16px; opacity: 0.9; }
    .small { font-size: 12px; opacity: 0.7; }
  </style>
  <script>
    function qs(key, def='') {
      const u = new URL(window.location.href);
      return u.searchParams.get(key) || def;
    }
    const channel = qs('channel', 'default');
    let lastId = '';

    function showBanner({ title, message, location, timestamp }) {
      const el = document.getElementById('banner');
      el.querySelector('.title').textContent = title || 'Deprem Ağı Uyarısı';
      const meta = [message, location].filter(Boolean).join(' • ');
      el.querySelector('.meta').textContent = meta || '';
      el.querySelector('.small').textContent = timestamp ? new Date(timestamp).toLocaleString() : '';
      el.classList.add('show');
      clearTimeout(window.__hideTimer);
      window.__hideTimer = setTimeout(() => el.classList.remove('show'), 12000);
    }

    async function poll() {
      try {
        const bust = Date.now();
        const url = `/api/poll?channel=${encodeURIComponent(channel)}${lastId ? `&since=${encodeURIComponent(lastId)}` : ''}&t=${bust}`;
        const r = await fetch(url, { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (j && j.update && j.payload) {
            lastId = j.payload.id || j.payload.timestamp || '';
            showBanner(j.payload);
          }
        }
      } catch {}
      setTimeout(poll, 1200);
    }
    window.addEventListener('DOMContentLoaded', poll);
  </script>
</head>
<body>
  <div id="banner" class="banner" role="status" aria-live="polite">
    <div class="pulse" aria-hidden="true"></div>
    <div class="content">
      <div class="title">Erken Uyarı</div>
      <div class="meta">Deprem Ağı uyarısı</div>
      <div class="small"></div>
    </div>
  </div>
</body>
</html>
