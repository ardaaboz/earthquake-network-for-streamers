<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deprem AÄŸÄ± â€¢ CanlÄ± YayÄ±n UyarÄ±</title>
  <style>
    :root {
      --bg: rgba(0,0,0,0.90);
      --bg2: rgba(0,0,0,0.96);
      --accent: #ff3b3b;
      --text: #fff;
      --muted: rgba(255,255,255,0.75);
    }
    html, body { margin: 0; padding: 0; background: transparent; overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif; }
    .banner {
      position: fixed; left: 50%; top: -220px; transform: translateX(-50%);
      width: min(520px, calc(100vw - 96px));
      color: var(--text);
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 16px 48px rgba(0,0,0,0.65);
      border-radius: 14px; backdrop-filter: blur(10px) saturate(125%);
      padding: 18px 22px 22px; display: grid; grid-template-columns: 1fr; gap: 10px; align-items: center; justify-items: center; text-align: center;
      transition: transform 420ms cubic-bezier(.2,.8,.2,1), top 420ms cubic-bezier(.2,.8,.2,1), opacity 320ms ease;
      opacity: 0;
    }
    .banner.show { top: 28px; opacity: 1; }
    .pulse { width: 18px; height: 18px; border-radius: 50%; background: #a90000; box-shadow: 0 0 0 0 rgba(169,0,0,0.8); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(169,0,0,0.8); } 70% { box-shadow: 0 0 0 16px rgba(169,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(169,0,0,0); } }
    .content { display: grid; gap: 4px; place-items: center; text-align: center; }
    .title { font-size: 22px; font-weight: 800; letter-spacing: 0.2px; }
    .meta { font-size: 16px; color: var(--muted); }
    .small { font-size: 12px; color: var(--muted); }
    #dbg { position: fixed; right: 10px; bottom: 10px; padding: 6px 8px; border-radius: 6px; background: rgba(0,0,0,0.45); color: #fff; font: 12px system-ui; display: none; }
  </style>
  <script>
    function qs(key, def='') { try { const u = new URL(window.location.href); return u.searchParams.get(key) || def; } catch { return def; } }
    const channel = qs('channel', 'default');
    let lastId = '';

    // Sound: prefer file if resolved, otherwise WebAudio chime
    const audioCfg = {
      enabled: qs('mute','0') !== '1' && qs('sound','1') !== '0',
      url: qs('soundUrl','/alert.mp3'),
      vol: Math.max(0, Math.min(1, parseFloat(qs('vol','1')) || 1)),
      dur: 0.35,
      resolved: false,
      ctx: null,
    };

    async function resolveSoundUrl() {
      try {
        const provided = qs('soundUrl','');
        const candidates = [];

        // Normalize provided soundUrl: support absolute, protocol URLs, and relative values
        if (provided) {
          const p = provided.trim();
          candidates.push(p);
          if (!/^https?:\/\//i.test(p)) {
            if (p[0] !== '/') candidates.push('/' + p);
          }
        }

        // Try common absolute paths first (Vercel/static hosting)
        candidates.push('/alert.mp3');

        // Also try relative paths for local-file usage (e.g., OBS "Local File")
        candidates.push('alert.mp3');
        candidates.push('./alert.mp3');

        // Dev server path (Express static under /static)
        candidates.push('/static/alert.mp3');

        // Legacy/incorrect but harmless to try on some hosts
        candidates.push('/public/alert.mp3');

        // Deduplicate while preserving order
        const seen = new Set();
        const unique = candidates.filter(u => { if (seen.has(u)) return false; seen.add(u); return true; });

        async function canFetch(u) {
          try { const h = await fetch(u, { method: 'HEAD', cache: 'no-store' }); if (h.ok) return true; } catch {}
          try { const g = await fetch(u, { method: 'GET', cache: 'no-store' }); if (g.ok) return true; } catch {}
          return false;
        }

        function canLoadWithAudio(u, timeoutMs = 2000) {
          return new Promise(resolve => {
            try {
              const a = new Audio();
              let done = false; const to = setTimeout(() => { if (!done) { done = true; resolve(false); } }, Math.max(500, timeoutMs));
              a.addEventListener('loadedmetadata', () => { if (!done) { done = true; clearTimeout(to); resolve(true); } }, { once: true });
              a.addEventListener('canplaythrough', () => { if (!done) { done = true; clearTimeout(to); resolve(true); } }, { once: true });
              a.addEventListener('error', () => { if (!done) { done = true; clearTimeout(to); resolve(false); } }, { once: true });
              a.src = u; a.preload = 'auto'; a.load();
            } catch { resolve(false); }
          });
        }

        for (const u of unique) {
          let ok = false;
          // Prefer fetch for network contexts; fall back to HTMLAudio detection
          if (location.protocol !== 'file:') ok = await canFetch(u);
          if (!ok) ok = await canLoadWithAudio(u);
          if (ok) { audioCfg.url = u; audioCfg.resolved = true; return; }
        }
      } catch {}
    }

    function ensureCtx() {
      try {
        if (!audioCfg.ctx) { const AC = window.AudioContext || window.webkitAudioContext; if (AC) audioCfg.ctx = new AC(); }
        if (audioCfg.ctx && audioCfg.ctx.state === 'suspended') audioCfg.ctx.resume();
      } catch {}
    }

    function primeAudio() {
      try {
        if (audioCfg.url && audioCfg.resolved) {
          const a = new Audio(audioCfg.url);
          a.preload = 'auto'; a.volume = audioCfg.vol;
          a.addEventListener('loadedmetadata', () => { if (a.duration && isFinite(a.duration)) audioCfg.dur = a.duration; }, { once: true });
          window.__alertProto = a;
          a.muted = true;
          const p = a.play(); if (p && p.then) p.then(() => { a.pause(); }).catch(() => {});
        } else {
          ensureCtx();
        }
      } catch {}
    }

    function playOnceAt(delayMs){ try { if (!audioCfg.enabled || !audioCfg.url) return; const src=(window.__alertProto&&window.__alertProto.src)||audioCfg.url; setTimeout(()=>{ try{ const a=new Audio(src); a.volume=audioCfg.vol; a.play().catch(()=>{});}catch{} }, Math.max(0,delayMs)); } catch {} }

    function chimeAt(delayMs) {
      try {
        ensureCtx(); const ctx = audioCfg.ctx; if (!ctx || !audioCfg.enabled) return;
        const t0 = ctx.currentTime + (delayMs / 1000);
        const out = ctx.createGain(); out.gain.value = 1; out.connect(ctx.destination);
        const mix = ctx.createGain(); mix.gain.value = Math.max(0.001, audioCfg.vol); mix.connect(out);
        const delay = ctx.createDelay(1.0); delay.delayTime.value = 0.14;
        const fb = ctx.createGain(); fb.gain.value = 0.22; const dmix = ctx.createGain(); dmix.gain.value = 0.25;
        delay.connect(fb).connect(delay); delay.connect(dmix).connect(mix);
        function voice(freq, det = 0) {
          const osc = ctx.createOscillator(); const g = ctx.createGain(); const lp = ctx.createBiquadFilter();
          lp.type = 'lowpass'; lp.frequency.setValueAtTime(3200, t0);
          osc.type = 'sine'; osc.frequency.setValueAtTime(freq, t0); if (det) osc.detune.setValueAtTime(det, t0);
          g.gain.setValueAtTime(0.0001, t0);
          g.gain.exponentialRampToValueAtTime(Math.max(0.001, audioCfg.vol * 0.9), t0 + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.35);
          osc.connect(g).connect(lp); lp.connect(mix); lp.connect(delay);
          osc.start(t0); osc.stop(t0 + 0.4);
        }
        voice(660, 0); voice(660, +4); voice(990, 0);
      } catch {}
    }

    function playPattern(){
      if (!audioCfg.enabled) return;
      if (audioCfg.url && audioCfg.resolved) {
        const d=Math.max(0.2, Math.min(2, audioCfg.dur||0.35)); const base=0;
        playOnceAt(base+0); playOnceAt(base+1*d*1000); playOnceAt(base+2*d*1000);
        const base2=base+3*d*1000+500; playOnceAt(base2+0); playOnceAt(base2+1*d*1000); playOnceAt(base2+2*d*1000);
      } else {
        chimeAt(0); chimeAt(300); chimeAt(600); const gap=600+500; chimeAt(gap+0); chimeAt(gap+300); chimeAt(gap+600);
      }
    }

    function showBanner(payload){
      const { displayTitle, displayMeta, title, message, location, timestamp, accent } = payload || {};
      if (accent) document.documentElement.style.setProperty('--accent', accent);
      const el=document.getElementById('banner');
      el.querySelector('.title').textContent = displayTitle || title || 'Deprem AÄŸÄ± UyarÄ±sÄ±';
      const meta = displayMeta || [message, location].filter(Boolean).join(' Â· ');
      el.querySelector('.meta').textContent = meta || '';
      try { const d = timestamp ? new Date(timestamp) : new Date(); const tr = new Intl.DateTimeFormat('tr-TR', { timeZone: 'Europe/Istanbul', year:'2-digit', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false }).format(d); el.querySelector('.small').textContent = tr; } catch { el.querySelector('.small').textContent=''; }
      playPattern();
      el.classList.add('show');
      clearTimeout(window.__hideTimer);
      window.__hideTimer = setTimeout(()=> el.classList.remove('show'), 12000);
    }

    let usingSSE=false; let sse;
    function startSSE(){ try { if (!('EventSource' in window)) return false; const url=`/events?channel=${encodeURIComponent(channel)}`; sse=new EventSource(url); sse.addEventListener('open',()=>{ usingSSE=true; dbg('sse open'); }); sse.addEventListener('alert', (e)=>{ try{ const payload=JSON.parse(e.data); lastId = payload.id || payload.timestamp || ''; showBanner(payload); }catch{} }); sse.addEventListener('error', ()=>{ dbg('sse error'); try{sse.close();}catch{} usingSSE=false; poll(); }); return true; } catch { return false; } }

    async function poll(){ try { const bust=Date.now(); const url=`/api/poll?channel=${encodeURIComponent(channel)}${lastId?`&since=${encodeURIComponent(lastId)}`:''}&t=${bust}`; const r=await fetch(url,{cache:'no-store'}); if(r.ok){ const j=await r.json(); dbg(`poll ok update=${!!(j&&j.update)}`); if(j&&j.update&&j.payload){ lastId = j.payload.id || j.payload.timestamp || ''; showBanner(j.payload); } } else { dbg(`poll ${r.status}`); } } catch(e){ dbg(`err ${(e&&e.message)||e}`); } setTimeout(poll, 1200); }

    function dbg(msg){ if(qs('debug','0')==='1'){ const d=document.getElementById('dbg'); if(d){ d.style.display='block'; d.textContent=msg; } } }
    window.addEventListener('DOMContentLoaded', ()=>{ const tried=startSSE(); setTimeout(()=>{ if(!usingSSE) poll(); }, 700); resolveSoundUrl().then(()=>{ primeAudio(); }); });
    window.addEventListener('pointerdown', ()=> primeAudio());
  </script>
</head>
<body>
  <div id="banner" class="banner" role="status" aria-live="polite">
    <div class="pulse" aria-hidden="true"></div>
    <div class="content">
      <div class="title">Erken UyarÄ±</div>
      <div class="meta">Deprem AÄŸÄ± uyarÄ±sÄ±</div>
      <div class="small"></div>
    </div>
  </div>


