<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deprem Ağı – Canlı Yayın Uyarı</title>
  <style>
    :root {
      --bg: rgba(0,0,0,0.65);
      --accent: #ff3b3b;
      --text: #fff;
    }
    html, body {
      margin: 0; padding: 0; background: transparent; overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, sans-serif;
    }
    .banner {
      position: fixed; left: 50%; top: -200px; transform: translateX(-50%);
      width: min(520px, calc(100vw - 96px));
      color: var(--text); background: var(--bg);
      border: 2px solid var(--accent);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
      border-radius: 10px; backdrop-filter: blur(6px);
      padding: 18px 22px 22px; display: flex; gap: 12px; align-items: center; justify-content: center; text-align: center;
      transition: transform 400ms ease, top 400ms ease, opacity 400ms ease;
      opacity: 0;
    }
    .banner.show {
      top: 24px; opacity: 1;
    }
    .pulse {
      width: 18px; height: 18px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 0 rgba(255,59,59,0.8);
      animation: pulse 1.5s infinite;
      flex: 0 0 auto;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,59,59,0.8); }
      70% { box-shadow: 0 0 0 16px rgba(255,59,59,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,59,59,0); }
    }
    .content { display: grid; gap: 4px; place-items: center; text-align: center; }
    .title { font-size: 22px; font-weight: 800; letter-spacing: 0.2px; }
    .meta { font-size: 16px; opacity: 0.9; }
    .small { font-size: 12px; opacity: 0.7; }
  </style>
  <script>
    function qs(key, def='') {
      const u = new URL(window.location.href);
      return u.searchParams.get(key) || def;
    }
    const channel = qs('channel', 'default');
    let lastId = '';

    // Optional alert sound from URL param `soundUrl`. Example: &soundUrl=/alert.mp3
    const audioCfg = {
      enabled: qs('mute','0') !== '1' && qs('sound','1') !== '0',
      url: qs('soundUrl',''),
      vol: Math.max(0, Math.min(1, parseFloat(qs('vol','1')) || 1)),
      dur: 0.35,
    };
    function primeAudio() {
      try {
        if (!audioCfg.url) return;
        const a = new Audio(audioCfg.url);
        a.preload = 'auto';
        a.volume = audioCfg.vol;
        a.addEventListener('loadedmetadata', () => {
          if (a.duration && isFinite(a.duration)) audioCfg.dur = a.duration;
        }, { once: true });
        window.__alertProto = a;
      } catch {}
    }
    function playOnceAt(delayMs) {
      try {
        if (!audioCfg.enabled || !audioCfg.url) return;
        const src = (window.__alertProto && window.__alertProto.src) || audioCfg.url;
        setTimeout(() => {
          try { const a = new Audio(src); a.volume = audioCfg.vol; a.play().catch(()=>{}); } catch {}
        }, Math.max(0, delayMs));
      } catch {}
    }
    function playPattern() {
      if (!audioCfg.enabled || !audioCfg.url) return;
      const d = Math.max(0.2, Math.min(2, audioCfg.dur || 0.35));
      const base = 0;
      playOnceAt(base + 0);
      playOnceAt(base + 1*d*1000);
      playOnceAt(base + 2*d*1000);
      const base2 = base + 3*d*1000 + 500;
      playOnceAt(base2 + 0);
      playOnceAt(base2 + 1*d*1000);
      playOnceAt(base2 + 2*d*1000);
    }

    function showBanner(payload) {
      const { displayTitle, displayMeta, title, message, location, timestamp, accent } = payload || {};
      const el = document.getElementById('banner');
      if (accent) {
        document.documentElement.style.setProperty('--accent', accent);
      }
      el.querySelector('.title').textContent = displayTitle || title || 'Deprem Ağı Uyarısı';
      const meta = displayMeta || [message, location].filter(Boolean).join(' • ');
      el.querySelector('.meta').textContent = meta || '';
      try {
        const d = timestamp ? new Date(timestamp) : new Date();
        const tr = new Intl.DateTimeFormat('tr-TR', { timeZone: 'Europe/Istanbul', year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).format(d);
        el.querySelector('.small').textContent = tr;
      } catch { el.querySelector('.small').textContent = ''; }
      playPattern();
      el.classList.add('show');
      clearTimeout(window.__hideTimer);
      window.__hideTimer = setTimeout(() => el.classList.remove('show'), 12000);
    }

    async function poll() {
      try {
        const bust = Date.now();
        const url = `/api/poll?channel=${encodeURIComponent(channel)}${lastId ? `&since=${encodeURIComponent(lastId)}` : ''}&t=${bust}`;
        const r = await fetch(url, { cache: 'no-store' });
        if (r.ok) {
          const j = await r.json();
          if (j && j.update && j.payload) {
            lastId = j.payload.id || j.payload.timestamp || '';
            showBanner(j.payload);
          }
        }
      } catch {}
      setTimeout(poll, 1200);
    }
    window.addEventListener('DOMContentLoaded', () => { primeAudio(); poll(); });
  </script>
</head>
<body>
  <div id="banner" class="banner" role="status" aria-live="polite">
    <div class="pulse" aria-hidden="true"></div>
    <div class="content">
      <div class="title">Erken Uyarı</div>
      <div class="meta">Deprem Ağı uyarısı</div>
      <div class="small"></div>
    </div>
  </div>
</body>
</html>
